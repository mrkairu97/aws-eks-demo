name: Deploy EKS Infrastructure

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region to deploy'
        required: true
        default: 'primary'
        type: choice
        options:
        - primary
        - dr
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy

env:
  TF_VERSION: '1.9.8'
  REGION_INPUT: ${{ github.event.inputs.region || 'primary' }}
  ACTION: ${{ github.event.inputs.action || 'deploy' }}

jobs:
  plan-infrastructure:
    name: Plan Core Infrastructure (VPC + EKS)
    runs-on: ubuntu-latest
    outputs:
      plan-exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Region Variables
        run: |
          if [ "${{ env.REGION_INPUT }}" = "dr" ]; then
            echo "AWS_REGION=ap-southeast-2" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-2" >> $GITHUB_ENV
          else
            echo "AWS_REGION=ap-southeast-1" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-1" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUMEROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Terraform Init
        run: terraform init

      - name: Select Terraform Workspace
        run: |
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}

      - name: Terraform Validate
        run: terraform validate

      - name: Refresh Terraform State
        run: terraform refresh -var-file="config/${{ env.ENVIRONMENT }}.tfvars"

      - name: Terraform Plan Core Infrastructure
        id: plan
        run: |
          if [ "${{ env.ACTION }}" = "destroy" ]; then
            terraform plan -var-file="config/${{ env.ENVIRONMENT }}.tfvars" -target=module.vpc -target=module.eks -destroy -out=tfplan-core -detailed-exitcode
          else
            terraform plan -var-file="config/${{ env.ENVIRONMENT }}.tfvars" -target=module.vpc -target=module.eks -out=tfplan-core -detailed-exitcode
          fi

      - name: Upload Core Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-core-${{ env.ENVIRONMENT }}
          path: tfplan-core
          retention-days: 1

  deploy-infrastructure:
    name: Deploy Core Infrastructure (VPC + EKS)
    runs-on: ubuntu-latest
    needs: plan-infrastructure
    if: always() && needs.plan-infrastructure.result == 'success' && github.event.inputs.action == 'deploy'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Region Variables
        run: |
          if [ "${{ env.REGION_INPUT }}" = "dr" ]; then
            echo "AWS_REGION=ap-southeast-2" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-2" >> $GITHUB_ENV
          else
            echo "AWS_REGION=ap-southeast-1" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-1" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUMEROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Terraform Init
        run: terraform init

      - name: Select Terraform Workspace
        run: |
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}

      - name: Download Core Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-core-${{ env.ENVIRONMENT }}

      - name: Deploy Core Infrastructure
        run: terraform apply -auto-approve tfplan-core

      - name: Wait for EKS Cluster to be Ready
        run: |
          # Get cluster name from terraform output
          CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "demo-eks-cluster")
          
          # Wait for cluster to be ACTIVE
          aws eks wait cluster-active --name $CLUSTER_NAME --region ${{ env.AWS_REGION }}
          
          echo "EKS cluster is ready!"

      - name: Clean up core plan artifact
        if: always()
        run: rm -f tfplan-core

  plan-k8s:
    name: Plan Kubernetes Resources
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: always() && needs.deploy-infrastructure.result == 'success' && github.event.inputs.action == 'deploy'
    outputs:
      plan-exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Region Variables
        run: |
          if [ "${{ env.REGION_INPUT }}" = "dr" ]; then
            echo "AWS_REGION=ap-southeast-2" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-2" >> $GITHUB_ENV
          else
            echo "AWS_REGION=ap-southeast-1" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-1" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUMEROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Terraform Init
        run: terraform init

      - name: Select Terraform Workspace
        run: |
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}

      - name: Refresh Terraform State
        run: terraform refresh -var-file="config/${{ env.ENVIRONMENT }}.tfvars"

      - name: Configure kubectl
        run: |
          CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "demo-eks-cluster")
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name $CLUSTER_NAME

      - name: Terraform Plan K8s Resources
        id: plan
        run: |
          terraform plan -var-file="config/${{ env.ENVIRONMENT }}.tfvars" -target=module.k8s -out=tfplan-k8s -detailed-exitcode

      - name: Upload K8s Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-k8s-${{ env.ENVIRONMENT }}
          path: tfplan-k8s
          retention-days: 1

  deploy-k8s:
    name: Deploy Kubernetes Resources
    runs-on: ubuntu-latest
    needs: plan-k8s
    if: always() && needs.plan-k8s.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Region Variables
        run: |
          if [ "${{ env.REGION_INPUT }}" = "dr" ]; then
            echo "AWS_REGION=ap-southeast-2" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-2" >> $GITHUB_ENV
          else
            echo "AWS_REGION=ap-southeast-1" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-1" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUMEROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Terraform Init
        run: terraform init

      - name: Select Terraform Workspace
        run: |
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}

      - name: Configure kubectl
        run: |
          CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "demo-eks-cluster")
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name $CLUSTER_NAME

      - name: Download K8s Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-k8s-${{ env.ENVIRONMENT }}

      - name: Deploy Kubernetes Resources
        run: terraform apply -auto-approve tfplan-k8s

      - name: Infrastructure Ready
        run: |
          echo "Infrastructure deployment complete!"
          echo "Use the 'Deploy Nginx Info App' workflow to deploy applications."

      - name: Clean up k8s plan artifact
        if: always()
        run: rm -f tfplan-k8s

  destroy-all:
    name: Destroy All Infrastructure
    runs-on: ubuntu-latest
    needs: plan-infrastructure
    if: always() && needs.plan-infrastructure.result == 'success' && github.event.inputs.action == 'destroy'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Region Variables
        run: |
          if [ "${{ env.REGION_INPUT }}" = "dr" ]; then
            echo "AWS_REGION=ap-southeast-2" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-2" >> $GITHUB_ENV
          else
            echo "AWS_REGION=ap-southeast-1" >> $GITHUB_ENV
            echo "ENVIRONMENT=ap-southeast-1" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ASSUMEROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Terraform Init
        run: terraform init

      - name: Select Terraform Workspace
        run: |
          terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}

      - name: Destroy K8s Resources First
        run: |
          terraform destroy -var-file="config/${{ env.ENVIRONMENT }}.tfvars" -target=module.k8s -auto-approve || true

      - name: Destroy Core Infrastructure
        run: |
          terraform destroy -var-file="config/${{ env.ENVIRONMENT }}.tfvars" -auto-approve